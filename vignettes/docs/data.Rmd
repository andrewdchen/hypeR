---
title: "Downloading Data"
vignette: >
  %\VignetteIndexEntry{Downloading Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE, messages=FALSE, warnings=FALSE}
knitr::opts_chunk$set(comment="", cache=FALSE, fig.align="center")
devtools::load_all(".")
library(reactable)
library(dplyr)
library(qusage)
library(igraph)
library(magrittr)
```

# Object oriented genesets

Genesets are simply a named list of character vectors which can be directly passed to `hyper()`. Alternatively, one can pass a `gsets` object, which can retain the name and version of the genesets one uses. This versioning will be included when exporting results or generating reports, which will ensure your results are reproducible.

```{r}

genesets <- list("GSET1" = c("GENE1", "GENE2", "GENE3"),
                 "GSET2" = c("GENE4", "GENE6"),
                 "GSET3" = c("GENE7", "GENE8", "GENE9"))

```

Creating a `gsets` object is easy...

```{r}

genesets <- gsets$new(genesets, name="Example Genesets", version="v1.0")
print(genesets)

```

```{r eval=FALSE}

hypeR(signature, genesets)

```

# Downloading genesets

To aid in workflow efficiency, __hypeR__ enables users to download genesets, wrapped as `gsets` objects, from multiple data sources.

## Downloading genesets from msigdb

For most purposes, the genesets hosted by [The Molecular Signatures Database](https://software.broadinstitute.org/gsea/msigdb/collections.jsp) are more than adequate to perform geneset enrichment analysis. There are various types of genesets available across many species.

### Available genesets

```{r}

msigdb_info()

```

### Downloading genesets

Here we download the Hallmarks genesets.

```{r}

HALLMARK <- msigdb_gsets(species="Homo sapiens", category="H")
print(HALLMARK)

```

This can be passed directly to `hypeR()`

```{r eval=FALSE}

hypeR(signature, genesets=HALLMARK)

```

Other commonly used genesets include Biocarta, Kegg, and Reactome. All of these objects can be passed directly to `hypeR()`.

```{r}

BIOCARTA <- msigdb_gsets(species="Homo sapiens", category="C2", subcategory="CP:BIOCARTA")
KEGG     <- msigdb_gsets(species="Homo sapiens", category="C2", subcategory="CP:KEGG")
REACTOME <- msigdb_gsets(species="Homo sapiens", category="C2", subcategory="CP:REACTOME")

```

## Downloading genesets from enrichr

If msigdb genesets are not sufficient, we have also provided another set of functions for downloading and loading other open source genesets. This is facilitated by interfacing with the publicly available [libraries](https://amp.pharm.mssm.edu/Enrichr/#stats) hosted by [Enrichr](https://amp.pharm.mssm.edu/Enrichr/).

### Available genesets

```{r}

available <- enrichr_available()
reactable(available)

```

### Downloading genesets

```{r}

ATLAS <- enrichr_gsets("Human_Gene_Atlas")
print(ATLAS)

```

Note these libraries do not have a systematic versioning scheme, however the data downloaded will be recorded.

# Relational Genesets

When dealing with hundreds of genesets, it's often useful to understand the relationships between them. This allows researchers to summarize many enriched pathways as more general biological processes. To do this, we rely on curated relationships defined between them. For example, [REACTOME](https://reactome.org/) conveniently defines their genesets in a [hiearchy of pathways](https://reactome.org/PathwayBrowser/). This data can be formatted into a relational genesets object called `rgsets`.

### Available genesets

We currently curate some relational genesets for use with __hypeR_ and plan to add more continuously.

```{r}

hyperdb_info()

```

### Downloading relational genesets

```{r}

REACTOME <- hyperdb_rgsets("REACTOME", "70.0")

```

This can be passed directly to `hypeR()`

```{r eval=FALSE}

hypeR(signature, genesets=REACTOME)

```

The only method which takes advantage of `rgsets` is `hyp_hmap()`, however all other functions will behave normally.

### Creating relational genesets

#### Data sources
Raw data for gsets, nodes, and edges can be directly downloaded.
```{r}

# All data downloaded from https://reactome.org/download-data
genesets.url <- "https://reactome.org/download/current/ReactomePathways.gmt.zip"
nodes.url <- "https://reactome.org/download/current/ReactomePathways.txt"
edges.url <- "https://reactome.org/download/current/ReactomePathwaysRelation.txt"

```

#### Loading data
```{r message=FALSE}

# Genesets
genesets.tmp <- tempfile(fileext=".gmt.zip")
download.file(genesets.url, destfile = genesets.tmp, mode = "wb")
genesets.raw <- genesets.tmp %>%
                unzip() %>%
                read.gmt() %>%
                lapply(function(x) {
                    toupper(x[x != "Reactome Pathway"])
                })
# Nodes
nodes.raw <- nodes.url %>%
             read.delim(sep="\t", 
                        header=FALSE, 
                        fill=TRUE, 
                        col.names=c("id", "label", "species"), 
                        stringsAsFactors=FALSE)
# Edges
edges.raw <- edges.url %>%
             read.delim(sep="\t", 
                        header=FALSE, 
                        fill=TRUE, 
                        col.names=c("from", "to"),
                        stringsAsFactors=FALSE)
```

#### Organizing a hierarchy
```{r}
# Species-specific nodes
nodes <- nodes.raw %>%
         filter( label %in% names(genesets.raw) ) %>%
         filter( species == "Homo sapiens" ) %>%
         filter(! duplicated(id) ) %>%
         set_rownames( .$id ) %>%
         { .[, "label", drop=FALSE] }

# Species-specific edges
edges <- edges.raw %>%
         filter( from %in% rownames(nodes) ) %>%
         filter( to %in% rownames(nodes) )

# Leaf genesets
genesets <- nodes %>%
            rownames() %>%
            .[! . %in% edges$from] %>%
            sapply( function(x) nodes[x, "label"] ) %>%
            genesets.raw[.]
```

##### nodes
A single-column data frame of labels where the rownames are unique identifiers. Leaf node labels should have an associated geneset, while internal nodes do not have to. The only genesets tested, will be those in the list of genesets.
```{r}
head(nodes)
```

##### edges
A dataframe with two columns of identifiers, indicating directed edges between nodes in the hierarchy.
```{r}
head(edges)
```

##### gsets
A list of character vectors, named by the geneset labels. Typically, genesets will be at the leaves of the hierarchy, while not required.
```{r}
head(names(genesets))
```

#### Using the `rgsets` object
```{r}
genesets <- rgsets$new(genesets, nodes, edges, name="REACTOME", version="v70.0")
print(genesets)
```
